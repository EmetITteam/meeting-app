<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM –ú–µ–Ω–µ–¥–∂–µ—Ä</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .meeting-card { height: 100%; }
        .spinner-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
    </style>
</head>
<body>
<div class="container my-3 my-md-4">
    </div>

<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h4>–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è...</h4>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-hidden="true">
    </div>


<div class="container my-3 my-md-4">
    <div id="login-screen">
        <div class="row justify-content-center"><div class="col-12 col-md-8 col-lg-6"><div class="card shadow-sm border-0"><div class="card-body p-4">
            <h1 class="card-title text-center h3 mb-4">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <form id="login-form"><div class="mb-3"><label for="username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label><input type="text" id="username" class="form-control" required></div><div class="mb-3"><label for="password" class="form-label">–ü–∞—Ä–æ–ª—å:</label><input type="password" id="password" class="form-control" required></div><button type="submit" id="login-button" class="btn btn-primary w-100 py-2">–í–æ–π—Ç–∏</button><p id="login-error" class="text-danger text-center mt-3 d-none"></p></form>
        </div></div></div></div>
    </div>
    <div id="main-app" class="d-none">
        <header class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center mb-4 pb-3 border-bottom"><h1 id="manager-header" class="h4 mb-3 mb-md-0"></h1><div class="d-flex gap-2 justify-content-center"><button id="show-add-form-btn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</button><button id="logout-btn" class="btn btn-secondary">–í—ã–π—Ç–∏</button></div></header>
        <main id="view-meetings"><h2 class="h3 mb-4 text-center">–í—Å—Ç—Ä–µ—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2><div id="meetings-list" class="row g-3"></div></main>
        <section id="form-section" class="d-none mt-4"><h2 id="form-title" class="h3 mb-3 text-center">–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</h2><form id="meeting-form" class="p-4 bg-light border rounded-3"><input type="hidden" id="meeting-id"><div class="row g-3"><div class="col-md-6"><label for="meeting-date" class="form-label">–î–∞—Ç–∞:</label><input type="date" id="meeting-date" class="form-control" required></div><div class="col-md-6"><label for="meeting-time" class="form-label">–í—Ä–µ–º—è:</label><input type="time" id="meeting-time" class="form-control" required></div><div class="col-12"><label for="client-name" class="form-label">–ö–ª–∏–µ–Ω—Ç:</label><input type="text" id="client-name" class="form-control" required></div><div class="col-12"><label for="purpose" class="form-label">–¶–µ–ª—å:</label><select id="purpose" class="form-select" required></select></div><div class="col-md-6"><label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label><input type="tel" id="phone" class="form-control" required></div><div class="col-md-6"><label for="status" class="form-label">–°—Ç–∞—Ç—É—Å:</label><select id="status" class="form-select"><option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option><option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∞">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option><option value="–ü–µ—Ä–µ–Ω–æ—Å">–ü–µ—Ä–µ–Ω–æ—Å</option><option value="–û—Ç–º–µ–Ω–∞">–û—Ç–º–µ–Ω–∞</option></select></div><div class="col-12"><label for="location" class="form-label">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:</label><div class="input-group"><input type="text" id="location" class="form-control"><button class="btn btn-outline-secondary" type="button" id="get-location-btn">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button></div></div></div><div class="d-flex gap-2 mt-4"><button type="submit" id="save-button" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button type="button" id="cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button></div></form></section>
    </div>
</div>
<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h1 class="modal-title fs-5" id="rescheduleModalLabel">–ü–µ—Ä–µ–Ω–æ—Å –≤—Å—Ç—Ä–µ—á–∏</h1><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>–£–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è –≤—Å—Ç—Ä–µ—á–∏.</p><div class="mb-3"><label for="newMeetingDate" class="form-label">–ù–æ–≤–∞—è –¥–∞—Ç–∞</label><input type="date" class="form-control" id="newMeetingDate" required></div><div><label for="newMeetingTime" class="form-label">–ù–æ–≤–æ–µ –≤—Ä–µ–º—è</label><input type="time" class="form-control" id="newMeetingTime" required></div><div id="rescheduleError" class="text-danger mt-2 d-none"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="button" class="btn btn-primary" id="saveRescheduleBtn">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button></div></div></div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwF1x4IxP31lN-CmIRZqE3uGqwdBvY6Ax89tp4WDtub9jJ00zDrq7pSuvcWH9qR6RkA/exec";

    const HIDDEN_CLASS = 'd-none'; 
    let currentUser = null, todaysMeetings = [], currentEditingMeeting = null;
    let meetingToReschedule = null; 
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const meetingsList = document.getElementById('meetings-list');
    const rescheduleModalEl = document.getElementById('rescheduleModal');
    const rescheduleModal = new bootstrap.Modal(rescheduleModalEl);
    const saveRescheduleBtn = document.getElementById('saveRescheduleBtn');
    // –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    document.addEventListener('DOMContentLoaded', () => { /* ... c–æ–±—ã—Ç–∏—è ... */ });

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

    function handleLogin(e) {
        e.preventDefault();
        loadingModal.show(); // –ü–û–ö–ê–ó–´–í–ê–ï–ú –û–ö–ù–û –ó–ê–ì–†–£–ó–ö–ò
        const loginBtn = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        loginBtn.disabled = true;
        loginError.classList.add(HIDDEN_CLASS);
        const payload = { login: document.getElementById('username').value, password: document.getElementById('password').value };
        callApi('login', payload).then(data => { onLoginSuccess({ login: payload.login }); }).catch(err => { onFailure(err, loginError); document.getElementById('password').value = ''; }).finally(() => { loginBtn.disabled = false; });
    }

    function onDataLoaded(data) {
        todaysMeetings = data.meetings;
        populatePurposes(data.purposes);
        displayMeetingsForToday();
        loadingModal.hide(); // –ü–†–Ø–ß–ï–ú –û–ö–ù–û –ó–ê–ì–†–£–ó–ö–ò
    }

    function displayMeetingsForToday() {
        meetingsList.innerHTML = '';
        if (todaysMeetings.length === 0) { /* ... */ }
        todaysMeetings.sort((a,b) => a.Time.localeCompare(b.Time)).forEach(m => {
            let actionButtons = `<button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${m.ID}">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-sm btn-outline-info geo-btn" data-id="${m.ID}">üìç Geo</button>`;
            if (m.Status !== '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' && m.Status !== '–û—Ç–º–µ–Ω–∞') { /* ... */ }

            // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø–µ—Ä–µ–Ω–æ—Å–µ
            let rescheduleInfo = '';
            if (m.Status === '–ü–µ—Ä–µ–Ω–æ—Å' && m.Comment) {
                rescheduleInfo = `<p class="card-text text-danger small mt-2"><em>${m.Comment}</em></p>`;
            }

            const cardHtml = `<div class="col-12 col-md-6"><div class="card meeting-card shadow-sm"><div class="card-body d-flex flex-column"><div class="flex-grow-1"><h5 class="card-title">${m.Time} - ${m.Client}</h5><p class="card-text mb-1"><small class="text-muted">–¶–µ–ª—å: ${m.Purpose}</small></p><p class="card-text mb-1"><small class="text-muted">–ê–¥—Ä–µ—Å: ${m.Location || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></p><p class="card-text mt-3"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${m.Status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>${rescheduleInfo}</div><div class="d-flex gap-2 mt-3 flex-wrap">${actionButtons}</div></div></div></div>`;
            meetingsList.innerHTML += cardHtml;
        });
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick));
        /* ... –ø—Ä–∏–≤—è–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ ... */
    }

    async function handleSaveReschedule() {
        const newDate = document.getElementById('newMeetingDate').value;
        const newTime = document.getElementById('newMeetingTime').value;
        if (!newDate || !newTime) { /* ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ ... */ return; }
        
        saveRescheduleBtn.disabled = true;
        try {
            // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—Ç–∞—Ä—É—é –≤—Å—Ç—Ä–µ—á—É
            const newDateFormatted = newDate.split('-').reverse().join('.');
            meetingToReschedule.Comment = `–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${newDateFormatted} ${newTime}`;
            
            const newMeetingData = { ...meetingToReschedule, ID: `m${Date.now()}`, Date: newDate.split('-').reverse().join('.'), Time: newTime, Status: '–í —Ä–∞–±–æ—Ç–µ', Comment: '' }; // –£ –Ω–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—É—Å—Ç–æ–π
            const updateOriginalMeetingPromise = callApi('updateMeeting', { newData: meetingToReschedule, oldData: currentEditingMeeting });
            const saveNewMeetingPromise = callApi('saveNewMeeting', newMeetingData);
            await Promise.all([updateOriginalMeetingPromise, saveNewMeetingPromise]);
            rescheduleModal.hide();
            onActionComplete();
            loadInitialData();
        } catch (error) {
            onFailure(error);
        } finally {
            saveRescheduleBtn.disabled = false;
        }
    }
    
    function onFailure(error, errorElement = null) {
        loadingModal.hide(); // –ü–†–Ø–ß–ï–ú –û–ö–ù–û –ó–ê–ì–†–£–ó–ö–ò –ü–†–ò –û–®–ò–ë–ö–ï
        console.error(error);
        if (errorElement) { /* ... */ }
    }

    // --- –ü–æ–ª–Ω—ã–π –∫–æ–¥ JS –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ---
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('logout-btn').addEventListener('click', () => window.location.reload()); document.getElementById('show-add-form-btn').addEventListener('click', showAddForm); document.getElementById('meeting-form').addEventListener('submit', handleFormSubmit); document.getElementById('cancel-btn').addEventListener('click', () => showForm(false)); document.getElementById('get-location-btn').addEventListener('click', handleGetLocationClick); saveRescheduleBtn.addEventListener('click', handleSaveReschedule); });
    function displayMeetingsForToday() { meetingsList.innerHTML = ''; if (todaysMeetings.length === 0) { meetingsList.innerHTML = '<p class="col-12 text-center text-muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç.</p>'; return; } todaysMeetings.sort((a,b) => a.Time.localeCompare(b.Time)).forEach(m => { let actionButtons = `<button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${m.ID}">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-sm btn-outline-info geo-btn" data-id="${m.ID}">üìç Geo</button>`; if (m.Status !== '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' && m.Status !== '–û—Ç–º–µ–Ω–∞') { actionButtons += `<button class="btn btn-sm btn-outline-warning reschedule-btn" data-id="${m.ID}">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>`; actionButtons += `<button class="btn btn-sm btn-success complete-btn" data-id="${m.ID}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`; } let rescheduleInfo = ''; if (m.Status === '–ü–µ—Ä–µ–Ω–æ—Å' && m.Comment) { rescheduleInfo = `<p class="card-text text-danger small mt-2"><em>${m.Comment}</em></p>`; } const cardHtml = `<div class="col-12 col-md-6"><div class="card meeting-card shadow-sm"><div class="card-body d-flex flex-column"><div class="flex-grow-1"><h5 class="card-title">${m.Time} - ${m.Client}</h5><p class="card-text mb-1"><small class="text-muted">–¶–µ–ª—å: ${m.Purpose}</small></p><p class="card-text mb-1"><small class="text-muted">–ê–¥—Ä–µ—Å: ${m.Location || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></p><p class="card-text mt-3"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${m.Status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>${rescheduleInfo}</div><div class="d-flex gap-2 mt-3 flex-wrap">${actionButtons}</div></div></div></div>`; meetingsList.innerHTML += cardHtml; }); document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick)); document.querySelectorAll('.complete-btn').forEach(btn => btn.addEventListener('click', handleCompleteClick)); document.querySelectorAll('.geo-btn').forEach(btn => btn.addEventListener('click', handleGeoClick)); document.querySelectorAll('.reschedule-btn').forEach(btn => btn.addEventListener('click', handleRescheduleClick)); window.scrollTo(0, 0); };
    async function callApi(action, payload) { const response = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, payload }) }); try { const result = await response.json(); if (result.status === 'error') { throw new Error(result.message); } return result.data; } catch (e) { if (response.ok) { return {}; } throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.'); } }
    function onLoginSuccess(result) { currentUser = result.login; document.getElementById('manager-header').textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä: ${currentUser}`; document.getElementById('login-screen').classList.add(HIDDEN_CLASS); document.getElementById('main-app').classList.remove(HIDDEN_CLASS); loadInitialData(); }
    function loadInitialData() { meetingsList.innerHTML = '<div class="col-12 text-center spinner-container"><div class="spinner-border text-primary" role="status"></div></div>'; callApi('getInitialData', { login: currentUser }).then(onDataLoaded).catch(onFailure); }
    function onFailure(error, errorElement = null) { loadingModal.hide(); console.error(error); if (errorElement) { errorElement.textContent = error.message; errorElement.classList.remove(HIDDEN_CLASS); } else { alert('–û—à–∏–±–∫–∞: ' + error.message); } }
    function handleFormSubmit(e) { e.preventDefault(); const saveBtn = document.getElementById('save-button'); saveBtn.disabled = true; const meetingId = document.getElementById('meeting-id').value; const isUpdating = !!meetingId; const data = { ID: isUpdating ? meetingId : `m${Date.now()}`, Date: document.getElementById('meeting-date').value.split('-').reverse().join('.'), Time: document.getElementById('meeting-time').value, Client: document.getElementById('client-name').value, Purpose: document.getElementById('purpose').value, Phone: document.getElementById('phone').value, Location: document.getElementById('location').value, Status: document.getElementById('status').value, ManagerLogin: currentUser, }; if (isUpdating && data.Status === '–ü–µ—Ä–µ–Ω–æ—Å') { meetingToReschedule = data; currentEditingMeeting = todaysMeetings.find(m => m.ID === data.ID); document.getElementById('newMeetingDate').value = ''; document.getElementById('newMeetingTime').value = ''; rescheduleModal.show(); saveBtn.disabled = false; return; } const action = isUpdating ? 'updateMeeting' : 'saveNewMeeting'; const payload = isUpdating ? { newData: data, oldData: currentEditingMeeting } : data; callApi(action, payload).then(() => { loadInitialData(); onActionComplete(); }).catch(onFailure).finally(() => { saveBtn.disabled = false; }); }
    function handleRescheduleClick(event) { const meetingId = event.target.dataset.id; const meetingData = todaysMeetings.find(m => m.ID === meetingId); if (!meetingData) return; meetingToReschedule = { ...meetingData, Status: '–ü–µ—Ä–µ–Ω–æ—Å' }; currentEditingMeeting = meetingData; document.getElementById('newMeetingDate').value = ''; document.getElementById('newMeetingTime').value = ''; rescheduleModal.show(); }
    function onActionComplete() { showForm(false); const saveBtn = document.getElementById('save-button'); if(saveBtn) saveBtn.disabled = false; }
    function showForm(show) { document.getElementById('view-meetings').classList.toggle(HIDDEN_CLASS, show); document.getElementById('form-section').classList.toggle(HIDDEN_CLASS, !show); document.querySelector('header').classList.toggle(HIDDEN_CLASS, show); }
    // ... –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
</script>
</body>
</html>
