<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM –ú–µ–Ω–µ–¥–∂–µ—Ä</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .meeting-card { height: 100%; }
        .spinner-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
    </style>
</head>
<body>
<div class="container my-3 my-md-4">
    <div id="login-screen">
        <div class="row justify-content-center"><div class="col-12 col-md-8 col-lg-6"><div class="card shadow-sm border-0"><div class="card-body p-4">
            <h1 class="card-title text-center h3 mb-4">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <form id="login-form"><div class="mb-3"><label for="username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label><input type="text" id="username" class="form-control" required></div><div class="mb-3"><label for="password" class="form-label">–ü–∞—Ä–æ–ª—å:</label><input type="password" id="password" class="form-control" required></div><button type="submit" id="login-button" class="btn btn-primary w-100 py-2">–í–æ–π—Ç–∏</button><p id="login-error" class="text-danger text-center mt-3 d-none"></p></form>
        </div></div></div></div>
    </div>

    <div id="main-app" class="d-none">
        <header class="d-flex flex-column flex-md-row justify-content-between align-items-center text-center mb-4 pb-3 border-bottom"><h1 id="manager-header" class="h4 mb-3 mb-md-0"></h1><div class="d-flex gap-2 justify-content-center"><button id="show-add-form-btn" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</button><button id="logout-btn" class="btn btn-secondary">–í—ã–π—Ç–∏</button></div></header>
        <main id="view-meetings"><h2 class="h3 mb-4 text-center">–í—Å—Ç—Ä–µ—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2><div id="meetings-list" class="row g-3"></div></main>
        <section id="form-section" class="d-none mt-4"><h2 id="form-title" class="h3 mb-3 text-center">–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞</h2><form id="meeting-form" class="p-4 bg-light border rounded-3"><input type="hidden" id="meeting-id"><div class="row g-3"><div class="col-md-6"><label for="meeting-date" class="form-label">–î–∞—Ç–∞:</label><input type="date" id="meeting-date" class="form-control" required></div><div class="col-md-6"><label for="meeting-time" class="form-label">–í—Ä–µ–º—è:</label><input type="time" id="meeting-time" class="form-control" required></div><div class="col-12"><label for="client-name" class="form-label">–ö–ª–∏–µ–Ω—Ç:</label><input type="text" id="client-name" class="form-control" required></div><div class="col-12"><label for="purpose" class="form-label">–¶–µ–ª—å:</label><select id="purpose" class="form-select" required></select></div><div class="col-md-6"><label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label><input type="tel" id="phone" class="form-control" required></div><div class="col-md-6"><label for="status" class="form-label">–°—Ç–∞—Ç—É—Å:</label><select id="status" class="form-select"><option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option><option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∞">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option><option value="–ü–µ—Ä–µ–Ω–æ—Å">–ü–µ—Ä–µ–Ω–æ—Å</option><option value="–û—Ç–º–µ–Ω–∞">–û—Ç–º–µ–Ω–∞</option></select></div><div class="col-12"><label for="location" class="form-label">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:</label><div class="input-group"><input type="text" id="location" class="form-control"><button class="btn btn-outline-secondary" type="button" id="get-location-btn">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button></div></div></div><div class="d-flex gap-2 mt-4"><button type="submit" id="save-button" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button type="button" id="cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button></div></form></section>
    </div>
</div>

<script>
    // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û –ó–î–ï–°–¨ –í–°–¢–ê–í–õ–ï–ù–ê –í–ê–®–ê –°–°–´–õ–ö–ê –ù–ê GOOGLE SCRIPT ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    const API_URL = "https://script.google.com/macros/s/AKfycbwF1x4IxP31lN-CmIRZqE3uGqwdBvY6Ax89tp4WDtub9jJ00zDrq7pSuvcWH9qR6RkA/exec";

    const HIDDEN_CLASS = 'd-none'; 
    let currentUser = null, todaysMeetings = [], currentEditingMeeting = null;
    const meetingsList = document.getElementById('meetings-list');
    
    // --- –ù–æ–≤–∞—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ API ---
    async function callApi(action, payload) {
        const response = await fetch(API_URL, {
            method: 'POST',
            redirect: 'follow', // –í–∞–∂–Ω–æ –¥–ª—è Google Script
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // –û–±—Ö–æ–¥ CORS
            body: JSON.stringify({ action, payload })
        });

        // Google Script –ø—Ä–∏ POST-–∑–∞–ø—Ä–æ—Å–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç.
        // –ú—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –∏–∑-–∑–∞ CORS, –Ω–æ –º–æ–∂–µ–º –µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
        try {
            const result = await response.json();
            if (result.status === 'error') {
                throw new Error(result.message);
            }
            return result.data;
        } catch (e) {
            // –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è, –Ω–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª (—Å—Ç–∞—Ç—É—Å 200),
            // –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –±—ã–ª —É—Å–ø–µ—à–Ω—ã–π POST (–ª–æ–≥–∏–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ).
            if (response.ok) {
                return {}; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É—è –æ–± —É—Å–ø–µ—Ö–µ
            }
            // –ò–Ω–∞—á–µ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
        }
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

    function handleLogin(e) {
        e.preventDefault();
        const loginBtn = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        loginBtn.disabled = true;
        loginError.classList.add(HIDDEN_CLASS);

        const payload = {
            login: usernameInput.value,
            password: passwordInput.value
        };

        callApi('login', payload)
            .then(data => {
                // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –æ–Ω–∞ –±—É–¥–µ—Ç –ø–æ–π–º–∞–Ω–∞ –≤ .catch
                // –ï—Å–ª–∏ –Ω–µ—Ç, –º—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —É—Å–ø–µ—Ö –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ª–æ–≥–∏–Ω
                onLoginSuccess({ login: payload.login });
            })
            .catch(err => {
                onFailure(err, loginError);
                passwordInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
            })
            .finally(() => {
                loginBtn.disabled = false;
            });
    }

    function onLoginSuccess(result) {
        currentUser = result.login;
        document.getElementById('manager-header').textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä: ${currentUser}`;
        document.getElementById('login-screen').classList.add(HIDDEN_CLASS);
        document.getElementById('main-app').classList.remove(HIDDEN_CLASS);
        loadInitialData();
    }

    function loadInitialData() {
        meetingsList.innerHTML = '<div class="col-12 text-center spinner-container"><div class="spinner-border text-primary" role="status"></div></div>';
        callApi('getInitialData', { login: currentUser })
            .then(onDataLoaded)
            .catch(onFailure);
    }
    
    function onDataLoaded(data) {
        todaysMeetings = data.meetings;
        populatePurposes(data.purposes);
        displayMeetingsForToday();
    }
    
    function handleFormSubmit(e) {
        e.preventDefault();
        const saveBtn = document.getElementById('save-button');
        saveBtn.disabled = true;

        const meetingId = document.getElementById('meeting-id').value;
        const isUpdating = !!meetingId;

        const data = {
            ID: isUpdating ? meetingId : `m${Date.now()}`, Date: document.getElementById('meeting-date').value.split('-').reverse().join('.'),
            Time: document.getElementById('meeting-time').value, Client: document.getElementById('client-name').value,
            Purpose: document.getElementById('purpose').value, Phone: document.getElementById('phone').value,
            Location: document.getElementById('location').value, Status: document.getElementById('status').value, ManagerLogin: currentUser,
        };

        const action = isUpdating ? 'updateMeeting' : 'saveNewMeeting';
        const payload = isUpdating ? { newData: data, oldData: currentEditingMeeting } : data;

        callApi(action, payload)
            .then(() => {
                loadInitialData();
                onActionComplete();
            })
            .catch(onFailure)
            .finally(() => { saveBtn.disabled = false; });
    }

    function handleCompleteClick(event) {
        const btn = event.target;
        btn.disabled = true;
        const meetingId = btn.dataset.id;
        const oldData = todaysMeetings.find(m => m.ID === meetingId);
        if (!oldData) return;
        if (!confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º "${oldData.Client}"?`)) {
            btn.disabled = false;
            return;
        }
        const newData = { ...oldData, Status: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' };
        callApi('updateMeeting', { newData, oldData })
            .then(() => loadInitialData())
            .catch(onFailure);
    }
    
    async function handleGeoClick(event) {
        const btn = event.target;
        btn.disabled = true;
        const meetingId = btn.dataset.id;
        const oldData = todaysMeetings.find(m => m.ID === meetingId);
        if (!oldData) return;
        try {
            const address = await getAddressFromGeolocation();
            const newData = { ...oldData, Location: address };
            await callApi('updateMeeting', { newData, oldData });
            loadInitialData();
        } catch (error) {
            alert(error.message);
            btn.disabled = false;
        }
    }

    function onFailure(error, errorElement = null) {
        console.error(error);
        if (errorElement) {
            errorElement.textContent = error.message;
            errorElement.classList.remove(HIDDEN_CLASS);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    }
    
    // --- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('logout-btn').addEventListener('click', () => window.location.reload()); document.getElementById('show-add-form-btn').addEventListener('click', showAddForm); document.getElementById('meeting-form').addEventListener('submit', handleFormSubmit); document.getElementById('cancel-btn').addEventListener('click', () => showForm(false)); document.getElementById('get-location-btn').addEventListener('click', handleGetLocationClick); });
    const displayMeetingsForToday = () => { meetingsList.innerHTML = ''; if (todaysMeetings.length === 0) { meetingsList.innerHTML = '<p class="col-12 text-center text-muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç.</p>'; return; } todaysMeetings.sort((a,b) => a.Time.localeCompare(b.Time)).forEach(m => { let actionButtons = `<button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${m.ID}">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-sm btn-outline-info geo-btn" data-id="${m.ID}">üìç Geo</button>`; if (m.Status !== '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' && m.Status !== '–û—Ç–º–µ–Ω–∞') { actionButtons += `<button class="btn btn-sm btn-success complete-btn" data-id="${m.ID}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`; } const cardHtml = `<div class="col-12 col-md-6"><div class="card meeting-card shadow-sm"><div class="card-body d-flex flex-column"><div class="flex-grow-1"><h5 class="card-title">${m.Time} - ${m.Client}</h5><p class="card-text mb-1"><small class="text-muted">–¶–µ–ª—å: ${m.Purpose}</small></p><p class="card-text mb-1"><small class="text-muted">–ê–¥—Ä–µ—Å: ${m.Location || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></p><p class="card-text mt-3"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${m.Status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p></div><div class="d-flex gap-2 mt-3 flex-wrap">${actionButtons}</div></div></div></div>`; meetingsList.innerHTML += cardHtml; }); document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick)); document.querySelectorAll('.complete-btn').forEach(btn => btn.addEventListener('click', handleCompleteClick)); document.querySelectorAll('.geo-btn').forEach(btn => btn.addEventListener('click', handleGeoClick)); window.scrollTo(0, 0); };
    function populatePurposes(purposes) { const purposeSelect = document.getElementById('purpose'); purposeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å --</option>'; purposes.forEach(p => { purposeSelect.innerHTML += `<option value="${p.Purpose}">${p.Purpose}</option>`; }); }
    async function handleGetLocationClick() { const btn = document.getElementById('get-location-btn'); const input = document.getElementById('location'); const originalText = btn.innerHTML; btn.disabled = true; btn.textContent = '...'; try { const address = await getAddressFromGeolocation(); input.value = address; } catch (error) { alert(error.message); } finally { btn.disabled = false; btn.innerHTML = originalText; } }
    async function getAddressFromGeolocation() { if (!navigator.geolocation) throw new Error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); return new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition( async (position) => { try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`); if (!response.ok) return reject(new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏')); const data = await response.json(); if (data && data.address) { const addr = data.address; resolve([addr.road, addr.house_number, addr.city || addr.town].filter(Boolean).join(', ')); } else { reject(new Error("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")); } } catch (e) { reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å")); } }, () => reject(new Error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏")), { timeout: 10000 }); }); }
    function handleEditClick(event) { const meetingId = event.target.dataset.id; currentEditingMeeting = todaysMeetings.find(m => m.ID === meetingId); if (!currentEditingMeeting) return; document.getElementById('form-title').textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏"; const dateParts = currentEditingMeeting.Date.split('.'); document.getElementById('meeting-date').value = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; document.getElementById('meeting-time').value = currentEditingMeeting.Time; document.getElementById('meeting-id').value = currentEditingMeeting.ID; document.getElementById('client-name').value = currentEditingMeeting.Client; document.getElementById('purpose').value = currentEditingMeeting.Purpose; document.getElementById('phone').value = currentEditingMeeting.Phone; document.getElementById('location').value = currentEditingMeeting.Location; document.getElementById('status').value = currentEditingMeeting.Status || '–í —Ä–∞–±–æ—Ç–µ'; showForm(true); }
    function showAddForm() { currentEditingMeeting = null; document.getElementById('form-title').textContent = "–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞"; document.getElementById('meeting-form').reset(); document.getElementById('meeting-date').value = new Date().toISOString().slice(0, 10); document.getElementById('meeting-id').value = ''; document.getElementById('status').value = '–í —Ä–∞–±–æ—Ç–µ'; showForm(true); }
    function onActionComplete() { showForm(false); const saveBtn = document.getElementById('save-button'); if(saveBtn) saveBtn.disabled = false; }
    function showForm(show) { document.getElementById('view-meetings').classList.toggle(HIDDEN_CLASS, show); document.getElementById('form-section').classList.toggle(HIDDEN_CLASS, !show); document.querySelector('header').classList.toggle(HIDDEN_CLASS, show); }
</script>
</body>
</html>
